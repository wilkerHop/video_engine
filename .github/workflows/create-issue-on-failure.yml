name: Create Issue on Workflow Failure

on:
  workflow_run:
    workflows: ["CI"]  # Monitor the CI workflow
    types:
      - completed

permissions:
  issues: write
  actions: read

jobs:
  create-issue-on-failure:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    
    steps:
      - name: Check if issue already exists
        id: check-issue
        uses: actions/github-script@v7
        with:
          script: |
            const workflow = context.payload.workflow_run;
            const runId = workflow.id;
            const issueTitle = `CI Failure: ${workflow.name} #${workflow.run_number}`;
            
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'ci-failure',
            });
            
            const existingIssue = issues.data.find(issue => 
              issue.title.includes(`${workflow.name} #${workflow.run_number}`)
            );
            
            return existingIssue ? existingIssue.number : null;

      - name: Create issue for failed workflow
        if: steps.check-issue.outputs.result == 'null'
        uses: actions/github-script@v7
        with:
          script: |
            const workflow = context.payload.workflow_run;
            const runNumber = workflow.run_number;
            const runId = workflow.id;
            const runUrl = workflow.html_url;
            const branch = workflow.head_branch;
            const commit = workflow.head_sha.substring(0, 7);
            const actor = workflow.actor.login;
            const triggeredBy = workflow.triggering_actor.login;
            
            const jobs = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: runId,
            });
            
            const failedJobs = jobs.data.jobs.filter(job => job.conclusion === 'failure');
            
            let jobDetails = '';
            for (const job of failedJobs) {
              jobDetails += `\n### âŒ ${job.name}\n`;
              jobDetails += `- **Duration**: ${Math.round((new Date(job.completed_at) - new Date(job.started_at)) / 1000)}s\n`;
              
              const failedSteps = job.steps.filter(step => step.conclusion === 'failure');
              if (failedSteps.length > 0) {
                jobDetails += `- **Failed Steps**:\n`;
                for (const step of failedSteps) {
                  jobDetails += `  - \`${step.name}\`\n`;
                }
              }
            }
            
            let issueTitle;
            if (failedJobs.length === 1) {
              issueTitle = `CI Failure: ${failedJobs[0].name} on ${branch}`;
            } else {
              issueTitle = `CI Failure: ${failedJobs.length} jobs failed on ${branch}`;
            }
            
            const issueBody = [
              '## ðŸš¨ Workflow Failed',
              '',
              `**Workflow**: ${workflow.name} ([#${runNumber}](${runUrl}))`,
              `**Branch**: \`${branch}\``,
              `**Commit**: \`${commit}\``,
              `**Triggered by**: @${triggeredBy}`,
              `**Run by**: @${actor}`,
              '',
              jobDetails,
              '',
              '---',
              '',
              '### ðŸ“‹ Quick Links',
              `- [View Workflow Run](${runUrl})`,
              `- [View Commit](https://github.com/${context.repo.owner}/${context.repo.repo}/commit/${workflow.head_sha})`,
              `- [View Branch](https://github.com/${context.repo.owner}/${context.repo.repo}/tree/${branch})`,
              '',
              '### ðŸ”§ Suggested Actions',
              '1. Review the failed job logs above',
              '2. Check if this is a flaky test or infrastructure issue',
              `3. Review recent changes in commit \`${commit}\``,
              '4. Re-run the workflow if it\'s a transient failure',
              '',
              '---',
              '',
              '**Auto-generated by workflow failure detector**',
              '*This issue was automatically created when the CI workflow failed*'
            ].join('\n');

            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: issueTitle,
              body: issueBody,
              labels: ['ci-failure', 'automated'],
              assignees: [triggeredBy],
            });
            
            console.log(`Created issue #${issue.data.number}: ${issueTitle}`);
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.data.number,
              body: `ðŸ’¡ **Tip**: If this is a transient failure, you can close this issue after verifying the fix. The workflow can be re-run from the [Actions tab](${runUrl}).`
            });

      - name: Comment on existing issue
        if: steps.check-issue.outputs.result != 'null'
        uses: actions/github-script@v7
        with:
          script: |
            const workflow = context.payload.workflow_run;
            const issueNumber = ${{ steps.check-issue.outputs.result }};
            const runUrl = workflow.html_url;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `ðŸ”„ **Workflow failed again**: [Run #${workflow.run_number}](${runUrl})\n\nThis failure is still occurring. Please investigate.`
            });
