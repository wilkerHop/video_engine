name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  CARGO_TERM_COLOR: always

jobs:
  test:
    name: Test Suite
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install Linux Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg libasound2-dev libudev-dev libxkbcommon-dev libwayland-dev

      - name: Cache cargo registry
        uses: actions/cache@v3
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v3
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v3
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}

      - name: Create CI Test Script
        run: |
          echo '{
            "metadata": {
              "title": "CI Demo",
              "resolution": "640x360",
              "fps": 30,
              "duration": 2.0
            },
            "scenes": [
              {
                "id": "scene1",
                "duration": 2.0,
                "layers": [
                  {
                    "type": "text",
                    "content": "CI Test",
                    "font": "assets/font.ttf",
                    "font_size": 48.0,
                    "color": { "r": 255, "g": 255, "b": 255 },
                    "position": { "x": 100, "y": 100 }
                  }
                ]
              }
            ]
          }' > examples/ci_test.json

      - name: Run Render Command (CI Test)
        run: cargo run -- render examples/ci_test.json --output ci_output --renderer native --force-cpu

      - name: Run health check
        run: chmod +x scripts/check_test_coverage.sh && ./scripts/check_test_coverage.sh

  clippy:
    name: Clippy (Lints)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: Install Linux Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg libasound2-dev libudev-dev libxkbcommon-dev libwayland-dev

      - name: Run clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

  fmt:
    name: Rustfmt (Code Formatting)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt

      - name: Check formatting
        run: cargo fmt --all -- --check

  build:
    name: Build
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install Linux Dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg libasound2-dev libudev-dev libxkbcommon-dev libwayland-dev
          sudo snap install blender --classic || echo "Snap failed, skipping Blender"

      - name: Install macOS Dependencies
        if: runner.os == 'macOS'
        run: |
          brew install ffmpeg
          brew install --cask blender

      - name: Install Windows Dependencies
        if: runner.os == 'Windows'
        run: |
          choco install ffmpeg
          choco install blender

      - name: Build
        run: cargo build --release --verbose

      - name: Cache Render Output
        uses: actions/cache@v3
        with:
          path: |
            .cache
            output
          key: render-cache-${{ runner.os }}-${{ github.sha }}
          restore-keys: |
            render-cache-${{ runner.os }}-

      - name: Run Engine (Generate Video)
        shell: bash
        run: |
          # Create a simple test script
          echo '{
            "metadata": {
              "title": "CI Demo",
              "resolution": "640x360",
              "fps": 30,
              "duration": 2.0
            },
            "scenes": [
              {
                "id": "scene1",
                "duration": 2.0,
                "layers": [
                  {
                    "type": "text",
                    "content": "CI Test",
                    "font": "assets/font.ttf",
                    "font_size": 48.0,
                    "color": { "r": 255, "g": 255, "b": 255 },
                    "position": { "x": 100, "y": 100 }
                  }
                ]
              }
            ]
          }' > examples/ci_test.json
          
          # Run the engine
          ./target/release/interstellar-triangulum render examples/ci_test.json
          
      - name: Upload Video Artifact
        uses: actions/upload-artifact@v4
        with:
          name: demo-video-${{ runner.os }}
          path: output.mp4

      - name: Upload Binary Artifact
        uses: actions/upload-artifact@v4
        with:
          name: interstellar-triangulum-${{ matrix.os }}
          path: |
            target/release/interstellar-triangulum*
            !target/release/interstellar-triangulum.d

  deploy:
    name: Deploy to GitHub Pages
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Linux Video
        uses: actions/download-artifact@v4
        with:
          name: demo-video-Linux
          path: video-linux

      - name: Download macOS Video
        uses: actions/download-artifact@v4
        with:
          name: demo-video-macOS
          path: video-macos

      - name: Download Windows Video
        uses: actions/download-artifact@v4
        with:
          name: demo-video-Windows
          path: video-windows

      - name: Download Apple Silicon Image
        # Note: Apple Silicon test produces an image frame, not a video yet
        uses: actions/download-artifact@v4
        continue-on-error: true # Optional, in case the other workflow hasn't finished
        with:
          name: demo-video-AppleSilicon
          path: video-apple-silicon

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Prepare Deployment
        run: |
          mkdir public
          cp index.html public/
          
          # Copy artifacts if they exist
          [ -f video-linux/output.mp4 ] && cp video-linux/output.mp4 public/output-linux.mp4
          [ -f video-macos/output.mp4 ] && cp video-macos/output.mp4 public/output-macos.mp4
          [ -f video-windows/output.mp4 ] && cp video-windows/output.mp4 public/output-windows.mp4
          [ -f video-apple-silicon/frame_0.png ] && cp video-apple-silicon/frame_0.png public/output-apple-silicon.png

      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
